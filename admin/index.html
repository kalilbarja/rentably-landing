<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rentably | Admin Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #818CF8;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--gray-900);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-700);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: white;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, #7C3AED 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            padding: 0 0.75rem;
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            padding: 0.5rem 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            color: var(--gray-400);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .nav-item:hover {
            background: var(--gray-800);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 100px;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--gray-700);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .user-info:hover {
            background: var(--gray-800);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.15s ease;
        }

        .search-box:focus-within {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            font-size: 0.9rem;
            width: 200px;
        }

        .search-box svg {
            color: var(--gray-400);
            width: 18px;
            height: 18px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .icon-btn:hover {
            background: var(--gray-200);
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        .lang-toggle {
            display: flex;
            background: var(--gray-100);
            border-radius: 6px;
            padding: 2px;
        }

        .lang-btn {
            padding: 0.4rem 0.75rem;
            border: none;
            background: none;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .lang-btn.active {
            background: white;
            color: var(--gray-900);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Page Content */
        .page-content {
            flex: 1;
            padding: 2rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.blue { background: #EEF2FF; color: var(--primary); }
        .stat-icon.green { background: #ECFDF5; color: var(--success); }
        .stat-icon.yellow { background: #FFFBEB; color: var(--warning); }
        .stat-icon.red { background: #FEF2F2; color: var(--danger); }

        .stat-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-trend {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 100px;
        }

        .stat-trend.up { background: #ECFDF5; color: var(--success); }
        .stat-trend.down { background: #FEF2F2; color: var(--danger); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
        }

        th {
            background: var(--gray-50);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        td {
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }

        tr:hover td {
            background: var(--gray-50);
        }

        /* Status Badges */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status.pending { background: #FEF3C7; color: #D97706; }
        .status.pending .status-dot { background: #D97706; }

        .status.in-progress { background: #DBEAFE; color: #2563EB; }
        .status.in-progress .status-dot { background: #2563EB; }

        .status.completed { background: #D1FAE5; color: #059669; }
        .status.completed .status-dot { background: #059669; }

        .status.occupied { background: #D1FAE5; color: #059669; }
        .status.vacant { background: var(--gray-100); color: var(--gray-600); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .btn-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.8rem;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        /* Request Item */
        .request-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-100);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .request-details {
            flex: 1;
        }

        .request-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .request-meta {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--gray-700);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            color: var(--gray-300);
        }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
            padding: 2rem;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: white;
            margin-bottom: 2rem;
        }

        .login-logo .logo-icon {
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
        }

        .login-logo .logo-text {
            font-size: 1.75rem;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            text-align: center;
            color: var(--gray-500);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 0.875rem;
            font-size: 1rem;
        }

        .login-error {
            background: #FEF2F2;
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Hide app when not logged in */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: flex;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            font-size: 1.25rem;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.15s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .success-toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 2000;
        }

        .success-toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo-icon">R</div>
                <span class="logo-text">Rentably</span>
            </div>
            <div class="login-card">
                <h1 class="login-title" data-translate="welcome_back">Welcome back</h1>
                <p class="login-subtitle" data-translate="login_subtitle">Sign in to your admin dashboard</p>
                
                <div class="login-error" id="loginError"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" data-translate="email">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="password">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-primary login-btn" id="loginBtn" data-translate="sign_in">
                        Sign In
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <div class="logo-icon">R</div>
                    <span class="logo-text">Rentably</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title" data-translate="nav_overview">Overview</div>
                    <a class="nav-item active" data-page="dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        <span data-translate="nav_dashboard">Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title" data-translate="nav_management">Management</div>
                    <a class="nav-item" data-page="requests">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                        </svg>
                        <span data-translate="nav_requests">Requests</span>
                        <span class="badge" id="requestsBadge">0</span>
                    </a>
                    <a class="nav-item" data-page="properties">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        <span data-translate="nav_properties">Properties</span>
                    </a>
                    <a class="nav-item" data-page="units">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="15" y1="3" x2="15" y2="21"/>
                        </svg>
                        <span data-translate="nav_units">Units</span>
                    </a>
                    <a class="nav-item" data-page="residents">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span data-translate="nav_residents">Residents</span>
                    </a>
                    <a class="nav-item" data-page="reports">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21H3V3"/>
                            <path d="M21 9l-6 6-4-4-6 6"/>
                        </svg>
                        <span data-translate="nav_reports">Reports</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title" data-translate="nav_settings">Settings</div>
                    <a class="nav-item" data-page="settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span data-translate="nav_settings">Settings</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info" onclick="logout()">
                    <div class="user-avatar" id="userAvatar">K</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Kalil</div>
                        <div class="user-role" id="userRole">Owner</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--gray-500)">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" placeholder="Search..." data-translate-placeholder="search">
                    </div>
                    <div class="lang-toggle">
                        <button class="lang-btn" onclick="setLanguage('es')">ES</button>
                        <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                    </div>
                    <button class="icon-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Dashboard Page -->
                <div class="page active" id="page-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon yellow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value" id="statPending">0</div>
                            <div class="stat-label" data-translate="pending_requests">Pending Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value" id="statInProgress">0</div>
                            <div class="stat-label" data-translate="in_progress">In Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value" id="statCompleted">0</div>
                            <div class="stat-label" data-translate="completed">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <line x1="3" y1="9" x2="21" y2="9"/>
                                        <line x1="9" y1="3" x2="9" y2="21"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value" id="statUnits">0</div>
                            <div class="stat-label" data-translate="total_units">Total Units</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title" data-translate="recent_requests">Recent Requests</h3>
                                <button class="btn btn-secondary btn-sm" onclick="showPage('requests')" data-translate="view_all">View All</button>
                            </div>
                            <div class="card-body" id="recentRequests">
                                <div class="empty-state">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                    <p data-translate="no_requests">No requests yet</p>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title" data-translate="properties_overview">Properties Overview</h3>
                                <button class="btn btn-secondary btn-sm" onclick="showPage('properties')" data-translate="view_all">View All</button>
                            </div>
                            <div class="card-body" id="propertiesOverview">
                                <div class="empty-state">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        <polyline points="9 22 9 12 15 12 15 22"/>
                                    </svg>
                                    <p>No properties yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requests Page -->
                <div class="page" id="page-requests">
                    <div class="card">
                        <div class="card-header">
                            <div class="tabs" style="margin-bottom:0;border-bottom:0;">
                                <div class="tab active" data-tab="pending" data-translate="pending">Pending</div>
                                <div class="tab" data-tab="in_progress" data-translate="in_progress">In Progress</div>
                                <div class="tab" data-tab="completed" data-translate="completed">Completed</div>
                                <div class="tab" data-tab="all" data-translate="all">All</div>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-translate="request">Request</th>
                                        <th data-translate="unit">Unit</th>
                                        <th data-translate="resident">Resident</th>
                                        <th data-translate="date">Date</th>
                                        <th data-translate="status">Status</th>
                                        <th data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTable">
                                    <tr>
                                        <td colspan="6" style="text-align:center;padding:3rem;color:var(--gray-500)" data-translate="no_requests_found">
                                            No requests found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Properties Page -->
                <div class="page" id="page-properties">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-translate="all_properties">All Properties</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddPropertyModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                <span data-translate="add_property">Add Property</span>
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-translate="property">Property</th>
                                        <th data-translate="address">Address</th>
                                        <th data-translate="units">Units</th>
                                        <th data-translate="occupancy">Occupancy</th>
                                        <th data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="propertiesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Units Page -->
                <div class="page" id="page-units">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-translate="all_units">All Units</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddUnitModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                <span data-translate="add_unit">Add Unit</span>
                            </button>
                        </div>
                        <!-- Filter Section -->
                        <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div class="form-group" style="margin: 0; min-width: 150px;">
                                <label class="form-label" style="margin-bottom: 0.25rem; font-size: 0.75rem;" data-translate="filter_property">Property</label>
                                <select class="form-select" id="unitFilterProperty" onchange="filterUnits()" style="padding: 0.5rem;">
                                    <option value="all" data-translate="all_properties">All Properties</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0; min-width: 150px;">
                                <label class="form-label" style="margin-bottom: 0.25rem; font-size: 0.75rem;" data-translate="filter_status">Status</label>
                                <select class="form-select" id="unitFilterStatus" onchange="filterUnits()" style="padding: 0.5rem;">
                                    <option value="all" data-translate="all">All</option>
                                    <option value="occupied" data-translate="occupied">Occupied</option>
                                    <option value="vacant" data-translate="vacant">Vacant</option>
                                </select>
                            </div>
                            <div style="margin-left: auto; color: var(--gray-500); font-size: 0.85rem;">
                                <span id="unitsCount">0</span> <span data-translate="units_shown">units</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-translate="unit">Unit</th>
                                        <th data-translate="property">Property</th>
                                        <th data-translate="bedrooms">Bedrooms</th>
                                        <th data-translate="rent">Rent</th>
                                        <th data-translate="status">Status</th>
                                        <th data-translate="resident">Resident</th>
                                        <th data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="unitsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Residents Page -->
                <div class="page" id="page-residents">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-translate="all_residents">All Residents</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddResidentModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                <span data-translate="add_resident">Add Resident</span>
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-translate="name">Name</th>
                                        <th data-translate="email">Email</th>
                                        <th data-translate="phone">Phone</th>
                                        <th data-translate="unit">Unit</th>
                                        <th data-translate="lease_end">Lease End</th>
                                        <th data-translate="status">Status</th>
                                        <th data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="residentsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div class="page" id="page-settings">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-translate="org_settings">Organization Settings</h3>
                        </div>
                        <div class="card-body">
                            <div style="max-width:500px">
                                <div class="form-group">
                                    <label class="form-label" data-translate="org_name">Organization Name</label>
                                    <input type="text" class="form-input" id="orgName" value="">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-translate="subdomain">Subdomain</label>
                                    <input type="text" class="form-input" id="orgSlug" value="" disabled>
                                    <small style="color:var(--gray-500);font-size:0.8rem">.rentably.io</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-translate="plan">Plan</label>
                                    <input type="text" class="form-input" id="orgPlan" value="" disabled>
                                </div>
                                <button class="btn btn-primary" onclick="saveSettings()" data-translate="save_changes">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div class="page" id="page-reports">
                    <!-- Report Filters -->
                    <div class="card" style="margin-bottom:1.5rem">
                        <div class="card-body" style="padding:1rem 1.5rem">
                            <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
                                <div class="form-group" style="margin:0">
                                    <label class="form-label" style="margin-bottom:0.25rem" data-translate="report_period">Period</label>
                                    <select class="form-select" id="reportPeriod" onchange="loadReports()" style="min-width:150px">
                                        <option value="month" data-translate="this_month">This Month</option>
                                        <option value="last_month" data-translate="last_month">Last Month</option>
                                        <option value="quarter" data-translate="this_quarter">This Quarter</option>
                                        <option value="year" data-translate="this_year">This Year</option>
                                        <option value="all" data-translate="all_time">All Time</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label class="form-label" style="margin-bottom:0.25rem" data-translate="property">Property</label>
                                    <select class="form-select" id="reportProperty" onchange="loadReports()" style="min-width:180px">
                                        <option value="all" data-translate="all_properties">All Properties</option>
                                    </select>
                                </div>
                                <div style="margin-left:auto">
                                    <button class="btn btn-secondary" onclick="exportReport()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="7 10 12 15 17 10"/>
                                            <line x1="12" y1="15" x2="12" y2="3"/>
                                        </svg>
                                        <span data-translate="export_csv">Export CSV</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="stats-grid" style="margin-bottom:1.5rem">
                        <div class="stat-card">
                            <div class="stat-icon" style="background:rgba(79,70,229,0.1);color:var(--primary)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="reportTotalRequests">0</div>
                                <div class="stat-label" data-translate="total_requests">Total Requests</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:rgba(16,185,129,0.1);color:var(--success)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="reportCompletedRequests">0</div>
                                <div class="stat-label" data-translate="completed">Completed</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:rgba(245,158,11,0.1);color:var(--warning)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="reportAvgDays">0</div>
                                <div class="stat-label" data-translate="avg_completion_days">Avg. Days to Complete</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:rgba(239,68,68,0.1);color:var(--danger)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"/>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="reportTotalCost">$0</div>
                                <div class="stat-label" data-translate="total_cost">Total Cost</div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
                        <!-- By Category -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title" data-translate="requests_by_category">Requests by Category</h3>
                            </div>
                            <div class="card-body">
                                <div id="categoryChart" style="min-height:250px"></div>
                            </div>
                        </div>

                        <!-- By Status -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title" data-translate="requests_by_status">Requests by Status</h3>
                            </div>
                            <div class="card-body">
                                <div id="statusChart" style="min-height:250px"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Cost by Category -->
                    <div class="card" style="margin-bottom:1.5rem">
                        <div class="card-header">
                            <h3 class="card-title" data-translate="cost_by_category">Cost by Category</h3>
                        </div>
                        <div class="card-body">
                            <div id="costChart" style="min-height:200px"></div>
                        </div>
                    </div>

                    <!-- Property Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" data-translate="property_breakdown">Property Breakdown</h3>
                        </div>
                        <div class="card-body" style="padding:0">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-translate="property">Property</th>
                                        <th data-translate="total_requests">Total Requests</th>
                                        <th data-translate="pending">Pending</th>
                                        <th data-translate="in_progress">In Progress</th>
                                        <th data-translate="completed">Completed</th>
                                        <th data-translate="total_cost">Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="propertyBreakdownTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Property Modal -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="propertyModalTitle" data-translate="add_property">Add Property</h3>
                <button class="modal-close" onclick="closePropertyModal()">×</button>
            </div>
            <form id="propertyForm">
                <div class="modal-body">
                    <input type="hidden" id="propertyId">
                    <div class="form-group">
                        <label class="form-label" data-translate="property_name">Property Name *</label>
                        <input type="text" class="form-input" id="propertyName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="address">Address</label>
                        <input type="text" class="form-input" id="propertyAddress">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate="city">City</label>
                            <input type="text" class="form-input" id="propertyCity">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate="country">Country</label>
                            <input type="text" class="form-input" id="propertyCountry" value="DO">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePropertyModal()" data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Unit Modal -->
    <div class="modal-overlay" id="unitModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="unitModalTitle" data-translate="add_unit">Add Unit</h3>
                <button class="modal-close" onclick="closeUnitModal()">×</button>
            </div>
            <form id="unitForm">
                <div class="modal-body">
                    <input type="hidden" id="unitId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate="unit_identifier">Unit # *</label>
                            <input type="text" class="form-input" id="unitIdentifier" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate="property">Property *</label>
                            <select class="form-select" id="unitProperty" required></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate="bedrooms">Bedrooms</label>
                            <input type="number" class="form-input" id="unitBedrooms" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate="bathrooms">Bathrooms</label>
                            <input type="number" class="form-input" id="unitBathrooms" min="0" step="0.5">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="rent">Monthly Rent</label>
                        <input type="number" class="form-input" id="unitRent" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUnitModal()" data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resident Modal -->
    <div class="modal-overlay" id="residentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="residentModalTitle" data-translate="add_resident">Add Resident</h3>
                <button class="modal-close" onclick="closeResidentModal()">×</button>
            </div>
            <form id="residentForm">
                <div class="modal-body">
                    <input type="hidden" id="residentId">
                    <div class="form-group">
                        <label class="form-label" data-translate="name">Name *</label>
                        <input type="text" class="form-input" id="residentName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate="email">Email *</label>
                            <input type="email" class="form-input" id="residentEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate="phone">Phone</label>
                            <input type="tel" class="form-input" id="residentPhone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="unit">Unit *</label>
                        <select class="form-select" id="residentUnit" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate="lease_start">Lease Start</label>
                            <input type="date" class="form-input" id="residentLeaseStart">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate="lease_end">Lease End</label>
                            <input type="date" class="form-input" id="residentLeaseEnd">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-translate="monthly_payment">Monthly Payment</label>
                        <input type="number" class="form-input" id="residentPayment" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeResidentModal()" data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div class="modal-overlay" id="requestModal">
        <div class="modal" style="max-width:600px">
            <div class="modal-header">
                <h3 class="modal-title" id="requestModalTitle" data-translate="request_details">Request Details</h3>
                <button class="modal-close" onclick="closeRequestModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="requestDetails"></div>
                
                <hr style="border:none;border-top:1px solid var(--gray-200);margin:1.5rem 0">
                
                <div class="form-group">
                    <label class="form-label" data-translate="status">Status</label>
                    <select class="form-select" id="requestStatus">
                        <option value="pending" data-translate="status_pending">Pending</option>
                        <option value="in_progress" data-translate="status_in_progress">In Progress</option>
                        <option value="completed" data-translate="status_completed">Completed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-translate="scheduled_date">Scheduled Date</label>
                    <input type="date" class="form-input" id="requestScheduledDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-translate="internal_notes">Internal Notes (not visible to resident)</label>
                    <textarea class="form-input" id="requestNotes" rows="3" style="resize:vertical"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-translate="cost">Cost</label>
                    <input type="number" class="form-input" id="requestCost" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRequestModal()" data-translate="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRequest()" data-translate="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="success-toast" id="successToast"></div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==============================================
        // CONFIGURATION
        // ==============================================
        const SUPABASE_URL = 'https://udmqecapkpkaluzuqjjk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkbXFlY2Fwa3BrYWx1enVxamprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTYxNDQsImV4cCI6MjA4NjMzMjE0NH0.Cp-2-xnz2JvCuenDuJiyJYIJEam8R9MIOZ83MCBra6s';
        
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==============================================
        // TRANSLATIONS
        // ==============================================
        const translations = {
            en: {
                // Login
                welcome_back: 'Welcome back',
                login_subtitle: 'Sign in to your admin dashboard',
                email: 'Email',
                password: 'Password',
                sign_in: 'Sign In',
                // Navigation
                nav_overview: 'Overview',
                nav_dashboard: 'Dashboard',
                nav_management: 'Management',
                nav_requests: 'Requests',
                nav_properties: 'Properties',
                nav_units: 'Units',
                nav_residents: 'Residents',
                nav_reports: 'Reports',
                nav_settings: 'Settings',
                // Dashboard
                pending_requests: 'Pending Requests',
                in_progress: 'In Progress',
                completed: 'Completed',
                total_units: 'Total Units',
                units_word: 'units',
                occupied_pct: 'occupied',
                recent_requests: 'Recent Requests',
                view_all: 'View All',
                properties_overview: 'Properties Overview',
                no_requests: 'No requests yet',
                no_properties: 'No properties yet',
                // Requests
                all_requests: 'All Requests',
                pending: 'Pending',
                all: 'All',
                request: 'Request',
                unit: 'Unit',
                resident: 'Resident',
                date: 'Date',
                status: 'Status',
                actions: 'Actions',
                view: 'View',
                no_requests_found: 'No requests found',
                // Properties
                all_properties: 'All Properties',
                add_property: 'Add Property',
                property: 'Property',
                address: 'Address',
                units: 'Units',
                occupancy: 'Occupancy',
                edit: 'Edit',
                no_properties_yet: 'No properties yet. Add your first property!',
                // Units
                all_units: 'All Units',
                add_unit: 'Add Unit',
                bedrooms: 'Bedrooms',
                rent: 'Rent',
                occupied: 'Occupied',
                vacant: 'Vacant',
                no_units_yet: 'No units yet. Add your first unit!',
                filter_property: 'Property',
                filter_status: 'Status',
                units_shown: 'units',
                // Residents
                all_residents: 'All Residents',
                add_resident: 'Add Resident',
                name: 'Name',
                phone: 'Phone',
                lease_end: 'Lease End',
                active: 'Active',
                inactive: 'Inactive',
                no_residents_yet: 'No residents yet. Add your first resident!',
                // Settings
                org_settings: 'Organization Settings',
                org_name: 'Organization Name',
                subdomain: 'Subdomain',
                plan: 'Plan',
                save_changes: 'Save Changes',
                // Search
                search: 'Search...',
                // Modals
                cancel: 'Cancel',
                save: 'Save',
                delete: 'Delete',
                property_name: 'Property Name',
                city: 'City',
                country: 'Country',
                unit_identifier: 'Unit #',
                bathrooms: 'Bathrooms',
                monthly_payment: 'Monthly Payment',
                lease_start: 'Lease Start',
                edit_property: 'Edit Property',
                edit_unit: 'Edit Unit',
                edit_resident: 'Edit Resident',
                saved_success: 'Saved successfully!',
                // Request Modal
                request_details: 'Request Details',
                scheduled_date: 'Scheduled Date',
                internal_notes: 'Internal Notes (not visible to resident)',
                cost: 'Cost',
                status_pending: 'Pending',
                status_in_progress: 'In Progress',
                status_completed: 'Completed',
                submitted_by: 'Submitted by',
                submitted_on: 'Submitted on',
                preferred_contact: 'Preferred Contact',
                preferred_time: 'Preferred Time',
                morning: 'Morning (8am-12pm)',
                afternoon: 'Afternoon (12pm-5pm)',
                // Categories
                cat_plumbing: 'Plumbing',
                cat_electrical: 'Electrical',
                cat_hvac: 'HVAC',
                cat_appliances: 'Appliances',
                cat_doors_windows: 'Doors/Windows',
                cat_pest_control: 'Pest Control',
                cat_structural: 'Structural',
                cat_other: 'Other',
                // Locations
                loc_kitchen: 'Kitchen',
                loc_bathroom_main: 'Main Bathroom',
                loc_bathroom_secondary: 'Secondary Bathroom',
                loc_bedroom: 'Bedroom',
                loc_living_room: 'Living Room',
                loc_laundry: 'Laundry',
                loc_exterior: 'Exterior',
                loc_common_area: 'Common Area'
            },
            es: {
                // Login
                welcome_back: 'Bienvenido',
                login_subtitle: 'Ingresa al panel de administración',
                email: 'Correo Electrónico',
                password: 'Contraseña',
                sign_in: 'Iniciar Sesión',
                // Navigation
                nav_overview: 'General',
                nav_dashboard: 'Dashboard',
                nav_management: 'Gestión',
                nav_requests: 'Solicitudes',
                nav_properties: 'Propiedades',
                nav_units: 'Unidades',
                nav_residents: 'Residentes',
                nav_reports: 'Reportes',
                nav_settings: 'Configuración',
                // Dashboard
                pending_requests: 'Solicitudes Pendientes',
                in_progress: 'En Progreso',
                completed: 'Completadas',
                total_units: 'Unidades Totales',
                units_word: 'unidades',
                occupied_pct: 'ocupado',
                recent_requests: 'Solicitudes Recientes',
                view_all: 'Ver Todas',
                properties_overview: 'Resumen de Propiedades',
                no_requests: 'No hay solicitudes aún',
                no_properties: 'No hay propiedades aún',
                // Requests
                all_requests: 'Todas las Solicitudes',
                pending: 'Pendiente',
                all: 'Todas',
                request: 'Solicitud',
                unit: 'Unidad',
                resident: 'Residente',
                date: 'Fecha',
                status: 'Estado',
                actions: 'Acciones',
                view: 'Ver',
                no_requests_found: 'No se encontraron solicitudes',
                // Properties
                all_properties: 'Todas las Propiedades',
                add_property: 'Agregar Propiedad',
                property: 'Propiedad',
                address: 'Dirección',
                units: 'Unidades',
                occupancy: 'Ocupación',
                edit: 'Editar',
                no_properties_yet: 'No hay propiedades. ¡Agrega tu primera propiedad!',
                // Units
                all_units: 'Todas las Unidades',
                add_unit: 'Agregar Unidad',
                bedrooms: 'Habitaciones',
                rent: 'Renta',
                occupied: 'Ocupado',
                vacant: 'Vacante',
                no_units_yet: 'No hay unidades. ¡Agrega tu primera unidad!',
                filter_property: 'Propiedad',
                filter_status: 'Estado',
                units_shown: 'unidades',
                // Residents
                all_residents: 'Todos los Residentes',
                add_resident: 'Agregar Residente',
                name: 'Nombre',
                phone: 'Teléfono',
                lease_end: 'Fin de Contrato',
                active: 'Activo',
                inactive: 'Inactivo',
                no_residents_yet: 'No hay residentes. ¡Agrega tu primer residente!',
                // Settings
                org_settings: 'Configuración de Organización',
                org_name: 'Nombre de Organización',
                subdomain: 'Subdominio',
                plan: 'Plan',
                save_changes: 'Guardar Cambios',
                // Search
                search: 'Buscar...',
                // Modals
                cancel: 'Cancelar',
                save: 'Guardar',
                delete: 'Eliminar',
                property_name: 'Nombre de Propiedad',
                city: 'Ciudad',
                country: 'País',
                unit_identifier: 'Unidad #',
                bathrooms: 'Baños',
                monthly_payment: 'Pago Mensual',
                lease_start: 'Inicio de Contrato',
                edit_property: 'Editar Propiedad',
                edit_unit: 'Editar Unidad',
                edit_resident: 'Editar Residente',
                saved_success: '¡Guardado exitosamente!',
                // Request Modal
                request_details: 'Detalles de Solicitud',
                scheduled_date: 'Fecha Programada',
                internal_notes: 'Notas Internas (no visible para residente)',
                cost: 'Costo',
                status_pending: 'Pendiente',
                status_in_progress: 'En Progreso',
                status_completed: 'Completada',
                submitted_by: 'Enviado por',
                submitted_on: 'Enviado el',
                preferred_contact: 'Contacto Preferido',
                preferred_time: 'Horario Preferido',
                morning: 'Mañana (8am-12pm)',
                afternoon: 'Tarde (12pm-5pm)',
                // Categories
                cat_plumbing: 'Plomería',
                cat_electrical: 'Eléctrico',
                cat_hvac: 'A/C',
                cat_appliances: 'Electrodomésticos',
                cat_doors_windows: 'Puertas/Ventanas',
                cat_pest_control: 'Control de Plagas',
                cat_structural: 'Estructural',
                cat_other: 'Otro',
                // Locations
                loc_kitchen: 'Cocina',
                loc_bathroom_main: 'Baño Principal',
                loc_bathroom_secondary: 'Baño Secundario',
                loc_bedroom: 'Habitación',
                loc_living_room: 'Sala',
                loc_laundry: 'Lavandería',
                loc_exterior: 'Exterior',
                loc_common_area: 'Área Común'
            }
        };

        let currentLang = localStorage.getItem('rentably-admin-lang') || 'en';
        
        // ==============================================
        // STATE
        // ==============================================
        let currentUser = null;
        let currentOrg = null;
        
        // ==============================================
        // AUTHENTICATION
        // ==============================================
        async function login(email, password) {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.textContent = 'Signing in...';
            loginBtn.disabled = true;
            
            try {
                const { data, error } = await db.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Get admin user profile
                const { data: adminUser, error: adminError } = await db
                    .from('admin_users')
                    .select('*')
                    .eq('user_id', data.user.id)
                    .single();
                
                if (adminError || !adminUser) {
                    throw new Error('No admin account found for this user');
                }
                
                // Get organization (using the first one for now)
                const { data: org } = await db
                    .from('organizations')
                    .select('*')
                    .limit(1)
                    .single();
                
                currentUser = adminUser;
                currentOrg = org;
                
                showApp();
                
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
                document.getElementById('loginError').classList.add('show');
                loginBtn.textContent = 'Sign In';
                loginBtn.disabled = false;
            }
        }
        
        async function logout() {
            await db.auth.signOut();
            currentUser = null;
            currentOrg = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }
        
        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            
            if (session) {
                const { data: adminUser } = await db
                    .from('admin_users')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .single();
                
                if (adminUser) {
                    const { data: org } = await db
                        .from('organizations')
                        .select('*')
                        .limit(1)
                        .single();
                    
                    currentUser = adminUser;
                    currentOrg = org;
                    showApp();
                }
            }
        }
        
        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').classList.add('active');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Update settings
            document.getElementById('orgName').value = currentOrg.name;
            document.getElementById('orgSlug').value = currentOrg.slug;
            document.getElementById('orgPlan').value = currentOrg.plan.charAt(0).toUpperCase() + currentOrg.plan.slice(1);
            
            // Load data
            loadDashboard();
        }
        
        // ==============================================
        // NAVIGATION
        // ==============================================
        function showPage(pageId) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                }
            });
            
            // Update page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            // Update title with translations
            const titles = {
                en: {
                    dashboard: 'Dashboard',
                    requests: 'Maintenance Requests',
                    properties: 'Properties',
                    units: 'Units',
                    residents: 'Residents',
                    reports: 'Reports & Analytics',
                    settings: 'Settings'
                },
                es: {
                    dashboard: 'Dashboard',
                    requests: 'Solicitudes de Mantenimiento',
                    properties: 'Propiedades',
                    units: 'Unidades',
                    residents: 'Residentes',
                    reports: 'Reportes y Análisis',
                    settings: 'Configuración'
                }
            };
            document.getElementById('pageTitle').textContent = titles[currentLang][pageId] || 'Dashboard';
            
            // Load page data
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'requests') loadRequests();
            if (pageId === 'properties') loadProperties();
            if (pageId === 'units') loadUnits();
            if (pageId === 'residents') loadResidents();
            if (pageId === 'reports') loadReports();
        }
        
        // ==============================================
        // DATA LOADING
        // ==============================================
        async function loadDashboard() {
            // Load stats
            const { data: requests } = await db
                .from('maintenance_requests')
                .select('status')
                .eq('organization_id', currentOrg.id);
            
            const { data: units } = await db
                .from('units')
                .select('id')
                .eq('organization_id', currentOrg.id);
            
            const pending = requests?.filter(r => r.status === 'pending').length || 0;
            const inProgress = requests?.filter(r => r.status === 'in_progress').length || 0;
            const completed = requests?.filter(r => r.status === 'completed').length || 0;
            
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statUnits').textContent = units?.length || 0;
            document.getElementById('requestsBadge').textContent = pending;
            
            // Load recent requests
            const { data: recentRequests } = await db
                .from('maintenance_requests')
                .select('*, residents(name), units(identifier)')
                .eq('organization_id', currentOrg.id)
                .order('created_at', { ascending: false })
                .limit(5);
            
            const recentEl = document.getElementById('recentRequests');
            if (recentRequests && recentRequests.length > 0) {
                recentEl.innerHTML = recentRequests.map(r => `
                    <div class="request-item">
                        <div class="request-icon">${getCategoryIcon(r.category)}</div>
                        <div class="request-details">
                            <div class="request-title">${getCategoryName(r.category)} - Unit ${r.units?.identifier || 'N/A'}</div>
                            <div class="request-meta">${r.residents?.name || 'Unknown'} • ${formatDate(r.created_at)}</div>
                        </div>
                        <span class="status ${r.status.replace('_', '-')}">
                            <span class="status-dot"></span>
                            ${getStatusName(r.status)}
                        </span>
                    </div>
                `).join('');
            }
            
            // Load properties overview
            const { data: properties } = await db
                .from('properties')
                .select('*, units(id, is_occupied)')
                .eq('organization_id', currentOrg.id);
            
            const propertiesEl = document.getElementById('propertiesOverview');
            if (properties && properties.length > 0) {
                propertiesEl.innerHTML = properties.map(p => {
                    const totalUnits = p.units?.length || 0;
                    const occupiedUnits = p.units?.filter(u => u.is_occupied).length || 0;
                    const occupancy = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;
                    const unitsWord = translations[currentLang].units_word;
                    const occupiedWord = translations[currentLang].occupied_pct;
                    return `
                        <div class="request-item">
                            <div class="request-icon">🏢</div>
                            <div class="request-details">
                                <div class="request-title">${p.name}</div>
                                <div class="request-meta">${p.city || 'No address'} • ${totalUnits} ${unitsWord}</div>
                            </div>
                            <span style="font-weight:600;color:var(--gray-700)">${occupancy}% ${occupiedWord}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        async function loadRequests(filter = 'pending') {
            const query = db
                .from('maintenance_requests')
                .select('*, residents(name), units(identifier), properties(name)')
                .eq('organization_id', currentOrg.id)
                .order('created_at', { ascending: false });
            
            if (filter !== 'all') {
                query.eq('status', filter);
            }
            
            const { data: requests } = await query;
            
            const tbody = document.getElementById('requestsTable');
            if (requests && requests.length > 0) {
                const viewText = currentLang === 'es' ? 'Ver' : 'View';
                const unknownText = currentLang === 'es' ? 'Desconocido' : 'Unknown';
                tbody.innerHTML = requests.map(r => `
                    <tr>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.75rem">
                                <div class="request-icon" style="width:36px;height:36px;font-size:1rem">${getCategoryIcon(r.category)}</div>
                                <div>
                                    <div style="font-weight:500">${getCategoryName(r.category)}</div>
                                    <div style="font-size:0.8rem;color:var(--gray-500)">${getLocationName(r.location)}</div>
                                </div>
                            </div>
                        </td>
                        <td>${r.units?.identifier || 'N/A'}</td>
                        <td>${r.residents?.name || unknownText}</td>
                        <td>${formatDate(r.created_at)}</td>
                        <td>
                            <span class="status ${r.status.replace('_', '-')}">
                                <span class="status-dot"></span>
                                ${getStatusName(r.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewRequest('${r.id}')">${viewText}</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                const noRequestsText = currentLang === 'es' ? 'No se encontraron solicitudes' : 'No requests found';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center;padding:3rem;color:var(--gray-500)">
                            ${noRequestsText}
                        </td>
                    </tr>
                `;
            }
        }
        
        async function loadProperties() {
            const { data: properties } = await db
                .from('properties')
                .select('*, units(id, is_occupied)')
                .eq('organization_id', currentOrg.id);
            
            const tbody = document.getElementById('propertiesTable');
            if (properties && properties.length > 0) {
                const editText = currentLang === 'es' ? 'Editar' : 'Edit';
                tbody.innerHTML = properties.map(p => {
                    const totalUnits = p.units?.length || 0;
                    const occupiedUnits = p.units?.filter(u => u.is_occupied).length || 0;
                    const occupancy = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;
                    return `
                        <tr>
                            <td style="font-weight:500">${p.name}</td>
                            <td>${p.address || '-'}, ${p.city || ''}</td>
                            <td>${totalUnits}</td>
                            <td>
                                <div style="display:flex;align-items:center;gap:0.5rem">
                                    <div style="flex:1;height:6px;background:var(--gray-200);border-radius:3px;max-width:100px">
                                        <div style="width:${occupancy}%;height:100%;background:var(--success);border-radius:3px"></div>
                                    </div>
                                    <span style="font-size:0.85rem;color:var(--gray-600)">${occupancy}%</span>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="editProperty('${p.id}')">${editText}</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                const noPropertiesText = currentLang === 'es' ? 'No hay propiedades. ¡Agrega tu primera propiedad!' : 'No properties yet. Add your first property!';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center;padding:3rem;color:var(--gray-500)">
                            ${noPropertiesText}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Store all units for filtering
        let allUnits = [];
        
        async function loadUnits() {
            const { data: units } = await db
                .from('units')
                .select('*, properties(name), residents(name)')
                .eq('organization_id', currentOrg.id)
                .order('identifier');
            
            allUnits = units || [];
            
            // Populate property filter dropdown
            const propertyFilter = document.getElementById('unitFilterProperty');
            const { data: properties } = await db
                .from('properties')
                .select('id, name')
                .eq('organization_id', currentOrg.id)
                .order('name');
            
            if (properties) {
                const allPropsText = currentLang === 'es' ? 'Todas las Propiedades' : 'All Properties';
                propertyFilter.innerHTML = `<option value="all">${allPropsText}</option>`;
                properties.forEach(p => {
                    propertyFilter.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            }
            
            filterUnits();
        }
        
        function filterUnits() {
            const propertyFilter = document.getElementById('unitFilterProperty').value;
            const statusFilter = document.getElementById('unitFilterStatus').value;
            
            let filtered = allUnits;
            
            // Filter by property
            if (propertyFilter !== 'all') {
                filtered = filtered.filter(u => u.property_id === propertyFilter);
            }
            
            // Filter by status
            if (statusFilter === 'occupied') {
                filtered = filtered.filter(u => u.is_occupied);
            } else if (statusFilter === 'vacant') {
                filtered = filtered.filter(u => !u.is_occupied);
            }
            
            // Update count
            document.getElementById('unitsCount').textContent = filtered.length;
            
            const tbody = document.getElementById('unitsTable');
            if (filtered.length > 0) {
                const occupiedText = currentLang === 'es' ? 'Ocupado' : 'Occupied';
                const vacantText = currentLang === 'es' ? 'Vacante' : 'Vacant';
                const editText = currentLang === 'es' ? 'Editar' : 'Edit';
                const bedText = currentLang === 'es' ? 'hab' : 'bed';
                const bathText = currentLang === 'es' ? 'baño' : 'bath';
                tbody.innerHTML = filtered.map(u => `
                    <tr>
                        <td style="font-weight:500">${u.identifier}</td>
                        <td>${u.properties?.name || '-'}</td>
                        <td>${u.bedrooms || '-'} ${bedText} / ${u.bathrooms || '-'} ${bathText}</td>
                        <td>${u.rent_amount ? '$' + u.rent_amount.toLocaleString() : '-'}</td>
                        <td>
                            <span class="status ${u.is_occupied ? 'occupied' : 'vacant'}">
                                ${u.is_occupied ? occupiedText : vacantText}
                            </span>
                        </td>
                        <td>${u.residents?.name || '-'}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="editUnit('${u.id}')">${editText}</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                const noUnitsText = currentLang === 'es' ? 'No hay unidades con estos filtros.' : 'No units match these filters.';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center;padding:3rem;color:var(--gray-500)">
                            ${noUnitsText}
                        </td>
                    </tr>
                `;
            }
        }
        
        async function loadResidents() {
            const { data: residents } = await db
                .from('residents')
                .select('*, units(identifier)')
                .eq('organization_id', currentOrg.id)
                .order('name');
            
            const tbody = document.getElementById('residentsTable');
            if (residents && residents.length > 0) {
                const activeText = currentLang === 'es' ? 'Activo' : 'Active';
                const inactiveText = currentLang === 'es' ? 'Inactivo' : 'Inactive';
                const editText = currentLang === 'es' ? 'Editar' : 'Edit';
                tbody.innerHTML = residents.map(r => `
                    <tr>
                        <td style="font-weight:500">${r.name}</td>
                        <td>${r.email}</td>
                        <td>${r.phone || '-'}</td>
                        <td>${r.units?.identifier || '-'}</td>
                        <td>${r.lease_end ? formatDate(r.lease_end) : '-'}</td>
                        <td>
                            <span class="status ${r.is_active ? 'completed' : 'pending'}">
                                ${r.is_active ? activeText : inactiveText}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="editResident('${r.id}')">${editText}</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                const noResidentsText = currentLang === 'es' ? 'No hay residentes. ¡Agrega tu primer residente!' : 'No residents yet. Add your first resident!';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center;padding:3rem;color:var(--gray-500)">
                            ${noResidentsText}
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==============================================
        // HELPERS
        // ==============================================
        function getCategoryIcon(category) {
            const icons = {
                plumbing: '🔧',
                electrical: '⚡',
                hvac: '❄️',
                appliances: '🔌',
                doors_windows: '🚪',
                pest_control: '🐛',
                structural: '🏗️',
                other: '📋'
            };
            return icons[category] || '📋';
        }
        
        function getCategoryName(category) {
            const names = {
                en: {
                    plumbing: 'Plumbing',
                    electrical: 'Electrical',
                    hvac: 'HVAC',
                    appliances: 'Appliances',
                    doors_windows: 'Doors/Windows',
                    pest_control: 'Pest Control',
                    structural: 'Structural',
                    other: 'Other'
                },
                es: {
                    plumbing: 'Plomería',
                    electrical: 'Eléctrico',
                    hvac: 'A/C',
                    appliances: 'Electrodomésticos',
                    doors_windows: 'Puertas/Ventanas',
                    pest_control: 'Control de Plagas',
                    structural: 'Estructural',
                    other: 'Otro'
                }
            };
            return names[currentLang][category] || category;
        }
        
        function getLocationName(location) {
            const names = {
                en: {
                    kitchen: 'Kitchen',
                    bathroom_main: 'Main Bathroom',
                    bathroom_secondary: 'Secondary Bathroom',
                    bedroom: 'Bedroom',
                    living_room: 'Living Room',
                    laundry: 'Laundry',
                    exterior: 'Exterior',
                    common_area: 'Common Area'
                },
                es: {
                    kitchen: 'Cocina',
                    bathroom_main: 'Baño Principal',
                    bathroom_secondary: 'Baño Secundario',
                    bedroom: 'Habitación',
                    living_room: 'Sala',
                    laundry: 'Lavandería',
                    exterior: 'Exterior',
                    common_area: 'Área Común'
                }
            };
            return names[currentLang][location] || location;
        }
        
        function getStatusName(status) {
            const names = {
                en: {
                    pending: 'Pending',
                    in_progress: 'In Progress',
                    completed: 'Completed',
                    cancelled: 'Cancelled'
                },
                es: {
                    pending: 'Pendiente',
                    in_progress: 'En Progreso',
                    completed: 'Completada',
                    cancelled: 'Cancelada'
                }
            };
            return names[currentLang][status] || status;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ==============================================
        // LANGUAGE
        // ==============================================
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('rentably-admin-lang', lang);
            
            // Update toggle buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === lang.toUpperCase()) {
                    btn.classList.add('active');
                }
            });

            // Update all translated elements
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update page title
            const titles = {
                dashboard: lang === 'es' ? 'Dashboard' : 'Dashboard',
                requests: lang === 'es' ? 'Solicitudes de Mantenimiento' : 'Maintenance Requests',
                properties: lang === 'es' ? 'Propiedades' : 'Properties',
                units: lang === 'es' ? 'Unidades' : 'Units',
                residents: lang === 'es' ? 'Residentes' : 'Residents',
                settings: lang === 'es' ? 'Configuración' : 'Settings'
            };
            const currentPage = document.querySelector('.nav-item.active')?.dataset.page || 'dashboard';
            document.getElementById('pageTitle').textContent = titles[currentPage] || 'Dashboard';

            // Reload current page data to update dynamic content
            if (currentOrg) {
                showPage(currentPage);
            }
        }

        function initLanguage() {
            // Set initial toggle state
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === currentLang.toUpperCase()) {
                    btn.classList.add('active');
                }
            });
            setLanguage(currentLang);
        }
        
        // ==============================================
        // MODALS - Property
        // ==============================================
        function showAddPropertyModal() {
            document.getElementById('propertyId').value = '';
            document.getElementById('propertyForm').reset();
            document.getElementById('propertyModalTitle').textContent = translations[currentLang].add_property;
            document.getElementById('propertyModal').classList.add('active');
        }

        async function editProperty(id) {
            const { data: property } = await db.from('properties').select('*').eq('id', id).single();
            if (property) {
                document.getElementById('propertyId').value = property.id;
                document.getElementById('propertyName').value = property.name || '';
                document.getElementById('propertyAddress').value = property.address || '';
                document.getElementById('propertyCity').value = property.city || '';
                document.getElementById('propertyCountry').value = property.country || 'DO';
                document.getElementById('propertyModalTitle').textContent = translations[currentLang].edit_property;
                document.getElementById('propertyModal').classList.add('active');
            }
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        async function saveProperty(e) {
            e.preventDefault();
            const id = document.getElementById('propertyId').value;
            const data = {
                organization_id: currentOrg.id,
                name: document.getElementById('propertyName').value,
                address: document.getElementById('propertyAddress').value,
                city: document.getElementById('propertyCity').value,
                country: document.getElementById('propertyCountry').value
            };

            if (id) {
                await db.from('properties').update(data).eq('id', id);
            } else {
                await db.from('properties').insert(data);
            }

            closePropertyModal();
            showToast(translations[currentLang].saved_success);
            loadProperties();
            loadDashboard();
        }

        // ==============================================
        // MODALS - Unit
        // ==============================================
        async function showAddUnitModal() {
            document.getElementById('unitId').value = '';
            document.getElementById('unitForm').reset();
            document.getElementById('unitModalTitle').textContent = translations[currentLang].add_unit;
            await loadPropertyOptions();
            document.getElementById('unitModal').classList.add('active');
        }

        async function editUnit(id) {
            const { data: unit } = await db.from('units').select('*').eq('id', id).single();
            if (unit) {
                await loadPropertyOptions();
                document.getElementById('unitId').value = unit.id;
                document.getElementById('unitIdentifier').value = unit.identifier || '';
                document.getElementById('unitProperty').value = unit.property_id || '';
                document.getElementById('unitBedrooms').value = unit.bedrooms || '';
                document.getElementById('unitBathrooms').value = unit.bathrooms || '';
                document.getElementById('unitRent').value = unit.rent_amount || '';
                document.getElementById('unitModalTitle').textContent = translations[currentLang].edit_unit;
                document.getElementById('unitModal').classList.add('active');
            }
        }

        function closeUnitModal() {
            document.getElementById('unitModal').classList.remove('active');
        }

        async function loadPropertyOptions() {
            const { data: properties } = await db.from('properties').select('id, name').eq('organization_id', currentOrg.id);
            const select = document.getElementById('unitProperty');
            select.innerHTML = '<option value="">-- Select --</option>' + 
                (properties || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        async function saveUnit(e) {
            e.preventDefault();
            const id = document.getElementById('unitId').value;
            const data = {
                organization_id: currentOrg.id,
                property_id: document.getElementById('unitProperty').value,
                identifier: document.getElementById('unitIdentifier').value,
                bedrooms: document.getElementById('unitBedrooms').value || null,
                bathrooms: document.getElementById('unitBathrooms').value || null,
                rent_amount: document.getElementById('unitRent').value || null
            };

            if (id) {
                await db.from('units').update(data).eq('id', id);
            } else {
                data.is_occupied = false;
                await db.from('units').insert(data);
            }

            closeUnitModal();
            showToast(translations[currentLang].saved_success);
            loadUnits();
            loadDashboard();
        }

        // ==============================================
        // MODALS - Resident
        // ==============================================
        async function showAddResidentModal() {
            document.getElementById('residentId').value = '';
            document.getElementById('residentForm').reset();
            document.getElementById('residentModalTitle').textContent = translations[currentLang].add_resident;
            await loadUnitOptions();
            document.getElementById('residentModal').classList.add('active');
        }

        async function editResident(id) {
            const { data: resident } = await db.from('residents').select('*').eq('id', id).single();
            if (resident) {
                await loadUnitOptions();
                document.getElementById('residentId').value = resident.id;
                document.getElementById('residentName').value = resident.name || '';
                document.getElementById('residentEmail').value = resident.email || '';
                document.getElementById('residentPhone').value = resident.phone || '';
                document.getElementById('residentUnit').value = resident.unit_id || '';
                document.getElementById('residentLeaseStart').value = resident.lease_start || '';
                document.getElementById('residentLeaseEnd').value = resident.lease_end || '';
                document.getElementById('residentPayment').value = resident.monthly_payment || '';
                document.getElementById('residentModalTitle').textContent = translations[currentLang].edit_resident;
                document.getElementById('residentModal').classList.add('active');
            }
        }

        function closeResidentModal() {
            document.getElementById('residentModal').classList.remove('active');
        }

        async function loadUnitOptions() {
            const { data: units } = await db.from('units').select('id, identifier, properties(name)').eq('organization_id', currentOrg.id);
            const select = document.getElementById('residentUnit');
            select.innerHTML = '<option value="">-- Select --</option>' + 
                (units || []).map(u => `<option value="${u.id}">${u.properties?.name} - ${u.identifier}</option>`).join('');
        }

        async function saveResident(e) {
            e.preventDefault();
            const id = document.getElementById('residentId').value;
            const unitId = document.getElementById('residentUnit').value;
            const data = {
                organization_id: currentOrg.id,
                unit_id: unitId,
                name: document.getElementById('residentName').value,
                email: document.getElementById('residentEmail').value,
                phone: document.getElementById('residentPhone').value || null,
                lease_start: document.getElementById('residentLeaseStart').value || null,
                lease_end: document.getElementById('residentLeaseEnd').value || null,
                monthly_payment: document.getElementById('residentPayment').value || null
            };

            if (id) {
                await db.from('residents').update(data).eq('id', id);
            } else {
                data.is_active = true;
                await db.from('residents').insert(data);
            }

            // Mark unit as occupied
            await db.from('units').update({ is_occupied: true }).eq('id', unitId);

            closeResidentModal();
            showToast(translations[currentLang].saved_success);
            loadResidents();
            loadUnits();
            loadDashboard();
        }

        // ==============================================
        // TOAST
        // ==============================================
        function showToast(message) {
            const toast = document.getElementById('successToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==============================================
        // MODALS - Request
        // ==============================================
        let currentRequestId = null;

        async function viewRequest(id) {
            currentRequestId = id;
            const { data: request } = await db
                .from('maintenance_requests')
                .select('*, residents(name, phone, email), units(identifier), properties(name)')
                .eq('id', id)
                .single();

            if (request) {
                const contactMethods = {
                    en: { phone: 'Phone Call', text: 'Text Message', email: 'Email' },
                    es: { phone: 'Llamada', text: 'Mensaje de Texto', email: 'Correo' }
                };
                const timeWindows = {
                    en: { morning: 'Morning (8am-12pm)', afternoon: 'Afternoon (12pm-5pm)' },
                    es: { morning: 'Mañana (8am-12pm)', afternoon: 'Tarde (12pm-5pm)' }
                };

                document.getElementById('requestDetails').innerHTML = `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
                        <div>
                            <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].category || 'Category'}</div>
                            <div style="font-weight:500;display:flex;align-items:center;gap:0.5rem">
                                <span>${getCategoryIcon(request.category)}</span>
                                ${getCategoryName(request.category)}
                            </div>
                        </div>
                        <div>
                            <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].location || 'Location'}</div>
                            <div style="font-weight:500">${getLocationName(request.location)}</div>
                        </div>
                    </div>
                    <div style="margin-bottom:1rem">
                        <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].description || 'Description'}</div>
                        <div style="background:var(--gray-50);padding:0.75rem;border-radius:8px;margin-top:0.25rem">${request.description || '-'}</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <div>
                            <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].submitted_by}</div>
                            <div style="font-weight:500">${request.residents?.name || '-'}</div>
                            <div style="font-size:0.85rem;color:var(--gray-500)">${request.properties?.name} - ${request.units?.identifier}</div>
                        </div>
                        <div>
                            <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].submitted_on}</div>
                            <div style="font-weight:500">${formatDate(request.created_at)}</div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
                        <div>
                            <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].preferred_contact}</div>
                            <div style="font-weight:500">${contactMethods[currentLang][request.contact_method] || request.contact_method || '-'}</div>
                            <div style="font-size:0.85rem;color:var(--gray-500)">${request.contact_phone || request.residents?.phone || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size:0.8rem;color:var(--gray-500)">${translations[currentLang].preferred_time}</div>
                            <div style="font-weight:500">${timeWindows[currentLang][request.time_window] || request.time_window || '-'}</div>
                        </div>
                    </div>
                    <div id="requestPhotosContainer" style="margin-top:1rem"></div>
                `;

                // Fetch photos for this request
                const { data: photos } = await db
                    .from('request_photos')
                    .select('*')
                    .eq('request_id', id)
                    .order('created_at', { ascending: true });

                if (photos && photos.length > 0) {
                    const photosLabel = currentLang === 'es' ? 'Fotos' : 'Photos';
                    document.getElementById('requestPhotosContainer').innerHTML = `
                        <div style="font-size:0.8rem;color:var(--gray-500);margin-bottom:0.5rem">${photosLabel} (${photos.length})</div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:0.5rem">
                            ${photos.map(p => `
                                <a href="${p.photo_url}" target="_blank" style="display:block;aspect-ratio:1;border-radius:8px;overflow:hidden;border:1px solid var(--gray-200)">
                                    <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover" alt="Request photo">
                                </a>
                            `).join('')}
                        </div>
                    `;
                }

                document.getElementById('requestStatus').value = request.status || 'pending';
                document.getElementById('requestScheduledDate').value = request.scheduled_date || '';
                document.getElementById('requestNotes').value = request.internal_notes || '';
                document.getElementById('requestCost').value = request.total_cost || '';
                
                document.getElementById('requestModal').classList.add('active');
            }
        }

        function closeRequestModal() {
            document.getElementById('requestModal').classList.remove('active');
            currentRequestId = null;
        }

        async function saveRequest() {
            if (!currentRequestId) return;

            const status = document.getElementById('requestStatus').value;
            const scheduledDate = document.getElementById('requestScheduledDate').value;
            
            // Get current request data for email
            const { data: currentRequest } = await db
                .from('maintenance_requests')
                .select('*, residents(name, email, phone), units(identifier), properties(name)')
                .eq('id', currentRequestId)
                .single();
            
            const previousStatus = currentRequest?.status;
            const previousScheduledDate = currentRequest?.scheduled_date;
            
            const data = {
                status: status,
                scheduled_date: scheduledDate || null,
                internal_notes: document.getElementById('requestNotes').value || null,
                total_cost: document.getElementById('requestCost').value || null
            };

            // Set completed_at if status changed to completed
            if (status === 'completed') {
                data.completed_at = new Date().toISOString();
            }

            const { error } = await db.from('maintenance_requests').update(data).eq('id', currentRequestId);
            
            if (error) {
                alert(translations[currentLang].error_saving || 'Error saving request');
                return;
            }

            // Send email notifications
            if (currentRequest?.residents?.email) {
                const categoryNames = {
                    plumbing: 'Plomería', electrical: 'Eléctrico', hvac: 'A/C', 
                    appliances: 'Electrodomésticos', doors_windows: 'Puertas/Ventanas',
                    pest_control: 'Plagas', structural: 'Estructural', other: 'Otro'
                };

                try {
                    // Email when scheduled date is set/changed
                    if (scheduledDate && scheduledDate !== previousScheduledDate) {
                        await fetch('/api/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'request_scheduled',
                                to: currentRequest.residents.email,
                                residentName: currentRequest.residents.name,
                                propertyName: currentRequest.properties?.name || '',
                                unitNumber: currentRequest.units?.identifier || '',
                                category: categoryNames[currentRequest.category] || currentRequest.category,
                                scheduledDate: scheduledDate
                            })
                        });

                        // Also send SMS if resident has phone number
                        if (currentRequest.residents.phone) {
                            await fetch('/api/send-sms', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    to: currentRequest.residents.phone,
                                    message: `Rentably: Su solicitud de mantenimiento (${categoryNames[currentRequest.category] || currentRequest.category}) ha sido programada para ${scheduledDate}. Por favor esté disponible.`
                                })
                            });
                        }
                    }

                    // Email when status changed to completed
                    if (status === 'completed' && previousStatus !== 'completed') {
                        await fetch('/api/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'request_completed',
                                to: currentRequest.residents.email,
                                residentName: currentRequest.residents.name,
                                propertyName: currentRequest.properties?.name || '',
                                unitNumber: currentRequest.units?.identifier || '',
                                category: categoryNames[currentRequest.category] || currentRequest.category
                            })
                        });
                    }
                } catch (emailErr) {
                    // Silent fail - don't block the save operation
                }
            }

            closeRequestModal();
            showToast(translations[currentLang].saved_success);
            loadRequests();
            loadDashboard();
        }

        // ==============================================
        // SAVE SETTINGS
        // ==============================================
        async function saveSettings() {
            const name = document.getElementById('orgName').value;
            await db.from('organizations').update({ name }).eq('id', currentOrg.id);
            currentOrg.name = name;
            showToast(translations[currentLang].saved_success);
        }

        // ==============================================
        // REPORTS
        // ==============================================
        async function loadReports() {
            const period = document.getElementById('reportPeriod')?.value || 'month';
            const propertyId = document.getElementById('reportProperty')?.value || 'all';
            
            // Calculate date range
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(2020, 0, 1); // All time
            }

            // Fetch requests
            let query = db
                .from('maintenance_requests')
                .select('*, properties(name), units(identifier)')
                .eq('organization_id', currentOrg.id)
                .gte('created_at', startDate.toISOString());

            if (propertyId !== 'all') {
                query = query.eq('property_id', propertyId);
            }

            const { data: requests } = await query;
            
            if (!requests) return;

            // Calculate stats
            const totalRequests = requests.length;
            const completedRequests = requests.filter(r => r.status === 'completed').length;
            const totalCost = requests.reduce((sum, r) => sum + (parseFloat(r.total_cost) || 0), 0);
            
            // Avg days to complete
            const completedWithDates = requests.filter(r => r.status === 'completed' && r.completed_at);
            let avgDays = 0;
            if (completedWithDates.length > 0) {
                const totalDays = completedWithDates.reduce((sum, r) => {
                    const created = new Date(r.created_at);
                    const completed = new Date(r.completed_at);
                    return sum + Math.ceil((completed - created) / (1000 * 60 * 60 * 24));
                }, 0);
                avgDays = Math.round(totalDays / completedWithDates.length);
            }

            // Update stat cards
            document.getElementById('reportTotalRequests').textContent = totalRequests;
            document.getElementById('reportCompletedRequests').textContent = completedRequests;
            document.getElementById('reportAvgDays').textContent = avgDays;
            document.getElementById('reportTotalCost').textContent = '$' + totalCost.toLocaleString();

            // Category breakdown
            const categoryNames = {
                plumbing: currentLang === 'es' ? 'Plomería' : 'Plumbing',
                electrical: currentLang === 'es' ? 'Eléctrico' : 'Electrical',
                hvac: 'HVAC',
                appliances: currentLang === 'es' ? 'Electrodomésticos' : 'Appliances',
                doors_windows: currentLang === 'es' ? 'Puertas/Ventanas' : 'Doors/Windows',
                pest_control: currentLang === 'es' ? 'Plagas' : 'Pest Control',
                structural: currentLang === 'es' ? 'Estructural' : 'Structural',
                other: currentLang === 'es' ? 'Otro' : 'Other'
            };

            const byCategory = {};
            const costByCategory = {};
            requests.forEach(r => {
                const cat = r.category || 'other';
                byCategory[cat] = (byCategory[cat] || 0) + 1;
                costByCategory[cat] = (costByCategory[cat] || 0) + (parseFloat(r.total_cost) || 0);
            });

            // Render category chart
            const categoryChart = document.getElementById('categoryChart');
            const maxCat = Math.max(...Object.values(byCategory), 1);
            categoryChart.innerHTML = Object.entries(byCategory)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, count]) => `
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem">
                        <div style="width:120px;font-size:0.85rem;color:var(--gray-600)">${categoryNames[cat] || cat}</div>
                        <div style="flex:1;height:24px;background:var(--gray-100);border-radius:4px;overflow:hidden">
                            <div style="width:${(count/maxCat)*100}%;height:100%;background:var(--primary);border-radius:4px"></div>
                        </div>
                        <div style="width:40px;text-align:right;font-weight:600">${count}</div>
                    </div>
                `).join('');

            // Status breakdown
            const byStatus = {
                pending: requests.filter(r => r.status === 'pending').length,
                in_progress: requests.filter(r => r.status === 'in_progress').length,
                completed: requests.filter(r => r.status === 'completed').length
            };

            const statusNames = {
                pending: currentLang === 'es' ? 'Pendiente' : 'Pending',
                in_progress: currentLang === 'es' ? 'En Progreso' : 'In Progress',
                completed: currentLang === 'es' ? 'Completado' : 'Completed'
            };

            const statusColors = {
                pending: 'var(--warning)',
                in_progress: 'var(--primary)',
                completed: 'var(--success)'
            };

            // Render status chart (donut-style with bars)
            const statusChart = document.getElementById('statusChart');
            const maxStatus = Math.max(...Object.values(byStatus), 1);
            statusChart.innerHTML = Object.entries(byStatus).map(([status, count]) => `
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem">
                    <div style="width:100px;font-size:0.85rem;color:var(--gray-600)">${statusNames[status]}</div>
                    <div style="flex:1;height:24px;background:var(--gray-100);border-radius:4px;overflow:hidden">
                        <div style="width:${(count/maxStatus)*100}%;height:100%;background:${statusColors[status]};border-radius:4px"></div>
                    </div>
                    <div style="width:40px;text-align:right;font-weight:600">${count}</div>
                </div>
            `).join('');

            // Cost by category chart
            const costChart = document.getElementById('costChart');
            const maxCost = Math.max(...Object.values(costByCategory), 1);
            costChart.innerHTML = Object.entries(costByCategory)
                .filter(([_, cost]) => cost > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, cost]) => `
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem">
                        <div style="width:120px;font-size:0.85rem;color:var(--gray-600)">${categoryNames[cat] || cat}</div>
                        <div style="flex:1;height:24px;background:var(--gray-100);border-radius:4px;overflow:hidden">
                            <div style="width:${(cost/maxCost)*100}%;height:100%;background:var(--danger);border-radius:4px"></div>
                        </div>
                        <div style="width:80px;text-align:right;font-weight:600">$${cost.toLocaleString()}</div>
                    </div>
                `).join('') || '<p style="color:var(--gray-500);text-align:center;padding:2rem">No cost data recorded</p>';

            // Property breakdown table
            const { data: properties } = await db
                .from('properties')
                .select('*')
                .eq('organization_id', currentOrg.id);

            const propertyTable = document.getElementById('propertyBreakdownTable');
            propertyTable.innerHTML = (properties || []).map(prop => {
                const propRequests = requests.filter(r => r.property_id === prop.id);
                const pending = propRequests.filter(r => r.status === 'pending').length;
                const inProgress = propRequests.filter(r => r.status === 'in_progress').length;
                const completed = propRequests.filter(r => r.status === 'completed').length;
                const cost = propRequests.reduce((sum, r) => sum + (parseFloat(r.total_cost) || 0), 0);
                
                return `
                    <tr>
                        <td><strong>${prop.name}</strong></td>
                        <td>${propRequests.length}</td>
                        <td><span class="status pending"><span class="status-dot"></span>${pending}</span></td>
                        <td><span class="status in-progress"><span class="status-dot"></span>${inProgress}</span></td>
                        <td><span class="status completed"><span class="status-dot"></span>${completed}</span></td>
                        <td>$${cost.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');

            // Populate property filter dropdown
            const reportPropertySelect = document.getElementById('reportProperty');
            const currentValue = reportPropertySelect.value;
            reportPropertySelect.innerHTML = `<option value="all" data-translate="all_properties">${currentLang === 'es' ? 'Todas las Propiedades' : 'All Properties'}</option>`;
            (properties || []).forEach(prop => {
                reportPropertySelect.innerHTML += `<option value="${prop.id}" ${prop.id === currentValue ? 'selected' : ''}>${prop.name}</option>`;
            });
        }

        function exportReport() {
            const period = document.getElementById('reportPeriod').value;
            const propertyId = document.getElementById('reportProperty').value;
            
            // Build query for export
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(2020, 0, 1);
            }

            // Fetch and export
            let query = db
                .from('maintenance_requests')
                .select('*, properties(name), units(identifier), residents(name)')
                .eq('organization_id', currentOrg.id)
                .gte('created_at', startDate.toISOString());

            if (propertyId !== 'all') {
                query = query.eq('property_id', propertyId);
            }

            query.then(({ data: requests }) => {
                if (!requests || requests.length === 0) {
                    showToast(currentLang === 'es' ? 'No hay datos para exportar' : 'No data to export');
                    return;
                }

                // Build CSV
                const headers = ['Date', 'Property', 'Unit', 'Resident', 'Category', 'Status', 'Cost', 'Description'];
                const rows = requests.map(r => [
                    new Date(r.created_at).toLocaleDateString(),
                    r.properties?.name || '',
                    r.units?.identifier || '',
                    r.residents?.name || '',
                    r.category || '',
                    r.status || '',
                    r.total_cost || '0',
                    (r.description || '').replace(/,/g, ';').replace(/\n/g, ' ')
                ]);

                const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rentably-report-${period}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                showToast(currentLang === 'es' ? 'Reporte exportado' : 'Report exported');
            });
        }
        
        // ==============================================
        // INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                login(email, password);
            });
            
            // Navigation
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    showPage(item.dataset.page);
                });
            });
            
            // Request tabs
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    loadRequests(tab.dataset.tab);
                });
            });
            
            // Check existing session
            checkSession();
            
            // Initialize language
            initLanguage();

            // Modal forms
            document.getElementById('propertyForm').addEventListener('submit', saveProperty);
            document.getElementById('unitForm').addEventListener('submit', saveUnit);
            document.getElementById('residentForm').addEventListener('submit', saveResident);
        });
    </script>
</body>
</html>
